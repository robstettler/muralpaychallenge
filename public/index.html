<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crypto Shop â€” Pay with USDC</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    header { background: #1a1a2e; color: #fff; padding: 20px 0; margin-bottom: 30px; }
    header .container { display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 1.5rem; }
    .cart-badge { background: #e94560; color: #fff; padding: 8px 18px; border-radius: 20px; cursor: pointer; font-weight: 600; }
    .cart-badge:hover { background: #c73a52; }

    /* Views */
    .view { display: none; }
    .view.active { display: block; }

    /* Products grid */
    .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
    .product-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s; }
    .product-card:hover { transform: translateY(-4px); }
    .product-card img { width: 100%; height: 200px; object-fit: cover; }
    .product-card .info { padding: 16px; }
    .product-card h3 { margin-bottom: 8px; }
    .product-card .desc { color: #666; font-size: 0.9rem; margin-bottom: 12px; line-height: 1.4; }
    .product-card .bottom { display: flex; justify-content: space-between; align-items: center; }
    .price { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; }
    .btn { padding: 8px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: background 0.2s; }
    .btn-primary { background: #e94560; color: #fff; }
    .btn-primary:hover { background: #c73a52; }
    .btn-secondary { background: #eee; color: #333; }
    .btn-secondary:hover { background: #ddd; }
    .btn-lg { padding: 14px 32px; font-size: 1.1rem; }

    /* Cart view */
    .cart-view { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid #eee; }
    .cart-item:last-child { border-bottom: none; }
    .cart-item .item-info h4 { margin-bottom: 4px; }
    .cart-item .item-info .qty { color: #666; font-size: 0.9rem; }
    .cart-item .item-price { font-weight: 700; font-size: 1.1rem; }
    .cart-item .remove-btn { color: #e94560; background: none; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 16px; }
    .cart-total { display: flex; justify-content: space-between; padding: 20px 0; font-size: 1.3rem; font-weight: 700; border-top: 2px solid #eee; margin-top: 12px; }
    .cart-actions { display: flex; gap: 12px; margin-top: 20px; justify-content: flex-end; }
    .empty-cart { text-align: center; padding: 40px; color: #999; }

    /* Checkout view */
    .checkout-view { background: #fff; border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .checkout-view h2 { margin-bottom: 24px; }
    .payment-details { background: #f9f9f9; border-radius: 8px; padding: 24px; margin: 20px 0; text-align: left; }
    .payment-details .field { margin-bottom: 16px; }
    .payment-details .label { font-size: 0.85rem; color: #666; margin-bottom: 4px; }
    .payment-details .value { font-family: 'Courier New', monospace; font-size: 1rem; word-break: break-all; background: #fff; padding: 10px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; position: relative; }
    .payment-details .value:hover::after { content: 'Click to copy'; position: absolute; top: -30px; right: 0; background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-family: sans-serif; }
    .amount-highlight { font-size: 2rem; font-weight: 700; color: #e94560; margin: 16px 0; }
    .countdown { font-size: 1.1rem; color: #666; margin: 16px 0; }
    .countdown .time { font-weight: 700; color: #e94560; }
    .status-badge { display: inline-block; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }
    .status-CREATING_WALLET { background: #e2e3f1; color: #383d6e; }
    .status-AWAITING_PAYMENT { background: #fff3cd; color: #856404; }
    .status-PAID { background: #d4edda; color: #155724; }
    .status-EXPIRED { background: #f8d7da; color: #721c24; }
    .success-icon { font-size: 4rem; margin-bottom: 16px; }

    /* Order items */
    .order-items { text-align: left; margin: 20px 0; }
    .order-items table { width: 100%; border-collapse: collapse; }
    .order-items th, .order-items td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #eee; }
    .order-items th { font-size: 0.85rem; color: #666; }

    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; background: #1a1a2e; color: #fff; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; z-index: 100; }
    .toast.show { opacity: 1; }

    /* Orders list */
    .orders-list { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .order-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid #eee; cursor: pointer; }
    .order-row:hover { background: #f9f9f9; }
    .order-row .order-id { font-family: monospace; font-size: 0.85rem; color: #666; }

    .nav-links { display: flex; gap: 16px; align-items: center; }
    .nav-link { color: #ccc; cursor: pointer; text-decoration: none; }
    .nav-link:hover { color: #fff; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Crypto Shop</h1>
      <div class="nav-links">
        <span class="nav-link" onclick="showView('orders-view')">My Orders</span>
        <span class="cart-badge" onclick="showView('cart-view')">Cart (<span id="cart-count">0</span>)</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Products View -->
    <div id="products-view" class="view active">
      <div class="products-grid" id="products-grid"></div>
    </div>

    <!-- Cart View -->
    <div id="cart-view" class="view">
      <div class="cart-view">
        <h2>Shopping Cart</h2>
        <div id="cart-items"></div>
        <div id="cart-footer"></div>
      </div>
    </div>

    <!-- Checkout View -->
    <div id="checkout-view" class="view">
      <div class="checkout-view" id="checkout-content"></div>
    </div>

    <!-- Orders View -->
    <div id="orders-view" class="view">
      <div class="orders-list">
        <h2>My Orders</h2>
        <div id="orders-list"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API = '/api';
    let cartId = localStorage.getItem('cartId');
    let cartItems = [];
    let currentOrderId = null;
    let pollInterval = null;

    // --- Init ---
    async function init() {
      await loadProducts();
      if (cartId) {
        try {
          await refreshCart();
        } catch {
          cartId = null;
          localStorage.removeItem('cartId');
        }
      }
    }

    // --- Products ---
    async function loadProducts() {
      const res = await fetch(`${API}/products`);
      const products = await res.json();
      const grid = document.getElementById('products-grid');
      grid.innerHTML = products.map(p => `
        <div class="product-card">
          <img src="${p.imageUrl}" alt="${p.name}" onerror="this.src='https://placehold.co/400x200?text=${encodeURIComponent(p.name)}'" />
          <div class="info">
            <h3>${p.name}</h3>
            <p class="desc">${p.description}</p>
            <div class="bottom">
              <span class="price">$${Number(p.priceUsdc).toFixed(2)} USDC</span>
              <button class="btn btn-primary" onclick="addToCart('${p.id}')">Add to Cart</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- Cart ---
    async function ensureCart() {
      if (!cartId) {
        const res = await fetch(`${API}/cart`, { method: 'POST' });
        const data = await res.json();
        cartId = data.id;
        localStorage.setItem('cartId', cartId);
      }
    }

    async function addToCart(productId) {
      await ensureCart();
      const res = await fetch(`${API}/cart/${cartId}/items`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, quantity: 1 }),
      });
      if (res.ok) {
        await refreshCart();
        showToast('Added to cart!');
      }
    }

    async function removeFromCart(productId) {
      const res = await fetch(`${API}/cart/${cartId}/items/${productId}`, { method: 'DELETE' });
      if (res.ok) await refreshCart();
    }

    async function refreshCart() {
      if (!cartId) { updateCartBadge(0); return; }
      const res = await fetch(`${API}/cart/${cartId}`);
      if (!res.ok) throw new Error('Cart not found');
      const data = await res.json();
      cartItems = data.items || [];
      updateCartBadge(cartItems.reduce((s, i) => s + i.quantity, 0));
      renderCart(data);
    }

    function updateCartBadge(count) {
      document.getElementById('cart-count').textContent = count;
    }

    function renderCart(data) {
      const itemsEl = document.getElementById('cart-items');
      const footerEl = document.getElementById('cart-footer');

      if (!data.items || data.items.length === 0) {
        itemsEl.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
        footerEl.innerHTML = '<div class="cart-actions"><button class="btn btn-secondary" onclick="showView(\'products-view\')">Continue Shopping</button></div>';
        return;
      }

      itemsEl.innerHTML = data.items.map(item => `
        <div class="cart-item">
          <div class="item-info">
            <h4>${item.product.name}</h4>
            <span class="qty">Qty: ${item.quantity}</span>
          </div>
          <div>
            <span class="item-price">$${(Number(item.product.priceUsdc) * item.quantity).toFixed(2)}</span>
            <button class="remove-btn" onclick="removeFromCart('${item.productId}')">Remove</button>
          </div>
        </div>
      `).join('');

      footerEl.innerHTML = `
        <div class="cart-total">
          <span>Total</span>
          <span>$${Number(data.totalUsdc).toFixed(2)} USDC</span>
        </div>
        <div class="cart-actions">
          <button class="btn btn-secondary" onclick="showView('products-view')">Continue Shopping</button>
          <button class="btn btn-primary btn-lg" onclick="checkout()">Checkout with USDC</button>
        </div>
      `;
    }

    // --- Checkout ---
    async function checkout() {
      if (!cartId || cartItems.length === 0) return;
      const res = await fetch(`${API}/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cartId }),
      });
      if (!res.ok) {
        const err = await res.json();
        showToast(err.message || 'Checkout failed');
        return;
      }
      const order = await res.json();
      currentOrderId = order.id;
      cartId = null;
      localStorage.removeItem('cartId');
      updateCartBadge(0);
      showView('checkout-view');
      renderCheckout(order);
      startPolling(order.id);
    }

    function renderCheckout(order) {
      const el = document.getElementById('checkout-content');

      if (order.status === 'PAID') {
        el.innerHTML = `
          <div class="success-icon">&#10003;</div>
          <h2>Payment Confirmed!</h2>
          <p>Your order has been paid successfully.</p>
          <p style="margin-top:12px;font-family:monospace;font-size:0.85rem;color:#666;">
            Tx: ${order.transactionHash || 'N/A'}
          </p>
          <div class="order-items">
            <table>
              <tr><th>Product</th><th>Qty</th><th>Price</th></tr>
              ${order.items.map(i => `<tr><td>${i.productName}</td><td>${i.quantity}</td><td>$${Number(i.unitPriceUsdc).toFixed(2)}</td></tr>`).join('')}
            </table>
          </div>
          <button class="btn btn-primary" onclick="showView('products-view')" style="margin-top:20px;">Continue Shopping</button>
        `;
        stopPolling();
        return;
      }

      if (order.status === 'EXPIRED') {
        el.innerHTML = `
          <h2>Order Expired</h2>
          <p>This order has expired. Please create a new order.</p>
          <button class="btn btn-primary" onclick="showView('products-view')" style="margin-top:20px;">Back to Shop</button>
        `;
        stopPolling();
        return;
      }

      if (order.status === 'CREATING_WALLET') {
        const expiresAt = new Date(order.expiresAt);
        el.innerHTML = `
          <h2>Preparing Your Payment</h2>
          <div style="margin:32px 0;">
            <div style="border:4px solid #eee;border-top:4px solid #e94560;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;margin:0 auto;"></div>
            <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
          </div>
          <p style="color:#666;">Setting up your payment wallet. This usually takes 15-20 seconds...</p>
          <div class="amount-highlight">$${Number(order.totalUsdc).toFixed(2)} USDC</div>
          <span class="status-badge status-CREATING_WALLET">Preparing Wallet</span>
          <div class="countdown">Time remaining: <span class="time" id="countdown"></span></div>

          <div class="order-items">
            <table>
              <tr><th>Product</th><th>Qty</th><th>Price</th></tr>
              ${order.items.map(i => `<tr><td>${i.productName}</td><td>${i.quantity}</td><td>$${Number(i.unitPriceUsdc).toFixed(2)}</td></tr>`).join('')}
            </table>
          </div>

          <p style="margin-top:20px;font-size:0.85rem;color:#666;">Order ID: ${order.id}</p>
        `;
        function updateCountdown() {
          const now = Date.now();
          const diff = expiresAt.getTime() - now;
          const cdEl = document.getElementById('countdown');
          if (!cdEl) return;
          if (diff <= 0) { cdEl.textContent = 'Expired'; return; }
          const mins = Math.floor(diff / 60000);
          const secs = Math.floor((diff % 60000) / 1000);
          cdEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);
        return;
      }

      const expiresAt = new Date(order.expiresAt);

      el.innerHTML = `
        <h2>Complete Your Payment</h2>
        <p>Send USDC to the wallet address below on <strong>${order.blockchain}</strong>.</p>
        <div class="amount-highlight">$${Number(order.totalUsdc).toFixed(2)} USDC</div>
        <span class="status-badge status-${order.status}">Awaiting Payment</span>
        <div class="countdown">Time remaining: <span class="time" id="countdown"></span></div>

        <div class="payment-details">
          <div class="field">
            <div class="label">Network</div>
            <div class="value" onclick="copyText(this)">${order.blockchain}</div>
          </div>
          <div class="field">
            <div class="label">Token</div>
            <div class="value" onclick="copyText(this)">${order.tokenSymbol}</div>
          </div>
          <div class="field">
            <div class="label">Wallet Address</div>
            <div class="value" onclick="copyText(this)">${order.walletAddress}</div>
          </div>
          <div class="field">
            <div class="label">Amount</div>
            <div class="value" onclick="copyText(this)">${Number(order.totalUsdc).toFixed(2)}</div>
          </div>
        </div>

        <div class="order-items">
          <table>
            <tr><th>Product</th><th>Qty</th><th>Price</th></tr>
            ${order.items.map(i => `<tr><td>${i.productName}</td><td>${i.quantity}</td><td>$${Number(i.unitPriceUsdc).toFixed(2)}</td></tr>`).join('')}
          </table>
        </div>

        <p style="margin-top:20px;font-size:0.85rem;color:#666;">Order ID: ${order.id}</p>
      `;

      // Countdown
      function updateCountdown() {
        const now = Date.now();
        const diff = expiresAt.getTime() - now;
        const cdEl = document.getElementById('countdown');
        if (!cdEl) return;
        if (diff <= 0) {
          cdEl.textContent = 'Expired';
          return;
        }
        const mins = Math.floor(diff / 60000);
        const secs = Math.floor((diff % 60000) / 1000);
        cdEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }

    // --- Polling ---
    function startPolling(orderId) {
      stopPolling();
      let lastStatus = null;
      pollInterval = setInterval(async () => {
        const res = await fetch(`${API}/orders/${orderId}`);
        if (!res.ok) return;
        const order = await res.json();
        if (order.status !== lastStatus) {
          lastStatus = order.status;
          renderCheckout(order);
          if (order.status === 'AWAITING_PAYMENT') startPolling(order.id);
        }
      }, 5000);
    }

    function stopPolling() {
      if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    }

    // --- Orders List ---
    async function loadOrders() {
      const res = await fetch(`${API}/orders`);
      if (!res.ok) return;
      const orders = await res.json();
      const el = document.getElementById('orders-list');
      if (orders.length === 0) {
        el.innerHTML = '<div class="empty-cart">No orders yet</div>';
        return;
      }
      el.innerHTML = orders.map(o => `
        <div class="order-row" onclick="viewOrder('${o.id}')">
          <div>
            <span class="order-id">${o.id.slice(0, 8)}...</span>
            <span style="margin-left:12px;">$${Number(o.totalUsdc).toFixed(2)} USDC</span>
          </div>
          <span class="status-badge status-${o.status}">${o.status}</span>
        </div>
      `).join('');
    }

    async function viewOrder(orderId) {
      const res = await fetch(`${API}/orders/${orderId}`);
      if (!res.ok) return;
      const order = await res.json();
      currentOrderId = order.id;
      showView('checkout-view');
      renderCheckout(order);
      if (order.status === 'AWAITING_PAYMENT' || order.status === 'CREATING_WALLET') startPolling(order.id);
    }

    // --- Navigation ---
    function showView(viewId) {
      stopPolling();
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.getElementById(viewId).classList.add('active');
      if (viewId === 'cart-view' && cartId) refreshCart();
      if (viewId === 'orders-view') loadOrders();
    }

    // --- Utils ---
    function copyText(el) {
      navigator.clipboard.writeText(el.textContent.trim());
      showToast('Copied!');
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }

    init();
  </script>
</body>
</html>
